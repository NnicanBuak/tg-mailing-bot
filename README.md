# tg-mailing-bot

## Требования
- **Функциональность**:
  - Отправка сообщений по заданным чатам (пользователи или группы) по расписанию.
  - Удобный интерфейс для создания и редактирования рассылок (текст, расписание, получатели).
  - Telegram Mini App для выбора получателей из списка чатов.
  - Возможность импорта идентификаторов чатов (в качестве альтернативы, если удобно).
  - Отслеживание статуса отправки (сколько отправлено, сколько не доставлено, причины ошибок).
  - Сбор общей статистики по рассылкам.
  - Возможность отслеживания переходов по ссылкам (если реализуемо).
- **Архитектурные требования**:
  - Использование Python 3.12.
  - Гибкий и расширяемый интерфейс.
  - Минимальные очевидные комментарии в коде, только для нестандартных решений.
  - Основное управление через Telegram, веб-интерфейс только для выбора получателей и других элементов.

## Архитектура

### Компоненты системы
Система состоит из трех основных компонентов:

1. **Telegram-бот**:
   - Реализован с использованием `python-telegram-bot`.
   - Отвечает за:
     - Обработку команд (`/create_broadcast`, `/set_message`, `/send_broadcast` и др.).
     - Отправку сообщений по расписанию с использованием `JobQueue`.
     - Обновление списка чатов в базе данных (добавление/удаление чатов).
     - Логирование результатов отправки.
   - **Нестандартное решение**: Расписания хранятся в базе данных, а не только в памяти `JobQueue`, для устойчивости к перезапускам. Это позволяет восстанавливать задачи при перезапуске бота.

2. **Telegram Mini App**:
   - Построена на основе Telegram Web Apps.
   - Предоставляет интерфейс для выбора получателей:
     - Отображает список чатов из базы данных с чекбоксами.
     - Отправляет выбранные чаты боту через `Telegram.WebApp.sendData`.
   - Открывается через inline-кнопку в Telegram, что обеспечивает интеграцию и аутентификацию через Telegram.
   - **Нестандартное решение**: Использование Mini App вместо отдельного веб-приложения упрощает развертывание и аутентификацию, так как всё происходит внутри Telegram.

3. **База данных**:
   - Используется PostgreSQL с ORM SQLAlchemy.
   - Хранит:
     - Список чатов (`Chats`).
     - Конфигурации рассылок (`Broadcasts`).
     - Связь рассылок и получателей (`Broadcast_Recipients`).
     - Логи отправки (`Send_Logs`).
   - **Нестандартное решение**: Совместная база данных для бота и Mini App обеспечивает синхронизацию данных и упрощает масштабирование.

### Схема базы данных
| Таблица                | Поля                                                                 |
|------------------------|----------------------------------------------------------------------|
| **Chats**             | `chat_id` (PK, bigint), `type` (varchar, user/group), `title` (varchar), `last_active` (timestamp) |
| **Broadcasts**        | `broadcast_id` (PK, serial), `message_text` (text), `next_run_time` (timestamp), `is_recurring` (boolean), `recurrence_interval` (varchar), `created_at` (timestamp), `created_by` (bigint) |
| **Broadcast_Recipients** | `broadcast_id` (FK, integer), `chat_id` (FK, bigint), PK (`broadcast_id`, `chat_id`) |
| **Send_Logs**         | `log_id` (PK, serial), `broadcast_id` (FK, integer), `chat_id` (FK, bigint), `send_time` (timestamp), `status` (varchar, success/failed), `error_message` (text) |

- **Chats**: Хранит информацию о чатах, в которых состоит бот.
- **Broadcasts**: Содержит конфигурацию рассылок, включая текст и расписание.
- **Broadcast_Recipients**: Связывает рассылки с получателями (многие-ко-многим).
- **Send_Logs**: Логирует каждую попытку отправки для отслеживания статуса.

### Рабочий процесс

#### 1. Управление чатами
- Бот отслеживает обновления от Telegram:
  - При добавлении в чат (группу, канал) или получении `/start` в личном чате добавляет запись в таблицу `Chats` с `chat_id`, `type`, `title` и `last_active`.
  - При удалении из чата (обновление `left_chat_member`) удаляет запись из `Chats`.
- Периодически обновляет `last_active` для активных чатов, чтобы поддерживать актуальный список.

#### 2. Создание и редактирование рассылки
- Администратор (chat_id в списке разрешенных) использует команды:
  - `/create_broadcast`: Создает новую запись в `Broadcasts`, возвращает `broadcast_id`.
  - `/set_message <broadcast_id> <текст>`: Устанавливает текст сообщения.
  - `/set_schedule <broadcast_id> <расписание>`: Устанавливает расписание (например, "daily at 09:00" или "2025-05-10 10:00").
  - `/select_recipients <broadcast_id>`: Отправляет сообщение с inline-кнопкой, открывающей Mini App.
- В Mini App:
  - Запрашивает список чатов через API-эндпоинт `/api/chats`, используя `user_id` из `Telegram.WebApp.initData` для проверки прав администратора.
  - Отображает чаты с чекбоксами, позволяет выбрать получателей.
  - При подтверждении вызывает `Telegram.WebApp.sendData` с JSON: `{"broadcast_id": <id>, "selected_chats": [<chat_id>, ...]}`.
- Бот получает данные через `callback_query`, обновляет `Broadcast_Recipients` для указанного `broadcast_id`.

#### 3. Отправка рассылки
- Бот проверяет `Broadcasts` на наличие запланированных рассылок (`next_run_time` в будущем).
- Для каждой рассылки:
  - Извлекает `message_text` и список получателей из `Broadcast_Recipients`.
  - Если немедленная отправка (`/send_broadcast <broadcast_id>`), запускает отправку сразу.
  - Если запланирована, добавляет задачу в `JobQueue` на `next_run_time`.
  - Отправляет сообщения с задержкой 0.1–0.5 сек между чатами, чтобы соблюдать лимиты Telegram (примерно 30 сообщений в секунду).
  - Логирует каждую попытку в `Send_Logs` (`status`: "success" или "failed", `error_message` при ошибке, например, "bot blocked").
- Для периодических рассылок (`is_recurring` = true) обновляет `next_run_time` после отправки.

#### 4. Статус и статистика
- При отправке рассылки бот отправляет сообщение администратору: "Начинаю отправку рассылки <broadcast_id>..." и редактирует его каждые 10 отправок или по завершении, показывая прогресс: "Отправлено 50/100, 2 не доставлено".
- Команда `/broadcast_status <broadcast_id>` показывает:
  - Общее количество получателей.
  - Количество успешных и неудачных отправок.
  - Список чатов с ошибками и их причины.
- Команда `/broadcast_stats` предоставляет общую статистику:
  - Количество рассылок.
  - Общее количество отправленных сообщений.
  - Процент успешных отправок.
- Данные извлекаются из `Send_Logs` и `Broadcasts`.

#### 5. Импорт идентификаторов (альтернатива)
- Команда `/import_recipients <broadcast_id> <chat_ids>` позволяет импортировать список `chat_id` (например, "123456789,-1001234567890").
- Бот проверяет, состоит ли он в указанных чатах, и добавляет их в `Broadcast_Recipients`.
- Это менее удобно, чем Mini App, но предоставляет альтернативу для быстрого добавления известных `chat_id`.

#### 6. Отслеживание переходов (будущая функция)
- Для отслеживания кликов по ссылкам:
  - В сообщения включаются ссылки, ведущие на сервер отслеживания (например, укорачиватель ссылок).
  - Сервер регистрирует клик и перенаправляет на целевой URL.
- Требует отдельного сервиса, который можно добавить позже.

## Расширяемость
- **Модульность**:
  - Код разделен на модули:
    - `bot.py`: Логика бота и обработка команд.
    - `database.py`: Модели SQLAlchemy и доступ к базе данных.
    - `mini_app/`: HTML/JS для Mini App.
  - Используются `ConversationHandler` из `python-telegram-bot` для пошагового создания рассылок.
- **Будущие функции**:
  - Поддержка медиа (фото, видео) в рассылках.
  - Расширенное планирование с использованием cron-выражений.
  - Уведомления об ошибках через Telegram.
  - Интеграция с сервисом отслеживания кликов.